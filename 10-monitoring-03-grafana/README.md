# Домашнее задание к занятию 14 «Средство визуализации Grafana»

### Задание 1

Доработал предложенный [docker-compose.yml](src/docker-compose.yml), добавил в него дополнительные сервисы:
* mail - для docker-mailserver, который в этой работе используется в качестве канала нотификации. Его настройки находятся в файле [dms.env](src/dms.env)
* roundcube - почтовый клиент для чтения писем
* rainloop - второй почтовый клиент для чтения писем, просто было интересно его посмотреть и сравнить с roundcube
* Добавил секцию настроек:
```
configs:
  grafana-ini:
    file: ./grafana/etc/grafana.ini
  grafana-repositories:
    file: ./grafana/etc/repositories
```
где указаны хостовые файлы, подставляемые при запуске в контейнер `grafana`, что позволяет указать более новый репозиторий `edge` для тестовой установки утилиты `swaks`, которая позволяет проверить отправку почты из CLI контейнера и файл настроек `grafana.ini`, где указаны настройки почтового сервера для отправки нотификаций по e-mail. Кроме того после разовой установки `swaks` в контейнер, я сделал `docker commit` с новым тагом `:swaks`, чтобы не устанавливать эту утилиту при каждом перезапуске контейнеров. Создал файлы для запуска, остановки и перезапуска docker-compose: `up.sh`, `down.sh`, `restart.sh`.

Вообще лучше по возможности избавляться от скриптов установки (в т.ч. IaC инструментами типа Ansible, etc.) пакетов дистрибутивов при деплое, потому что иногда пакеты или репозитории могут оказаться сбойными. 

Нет ничего плохого в ручной установке пакетов репозитория внутрь работающего контейнера во время разработки образа контейнера, тестирования контейнера и даже для регулярной предварительной автоматической сборки контейнера в пайплайне (можно использовать `docker commit` из IaC вместо специализированных сборочных инструментов, это бывает даже удобнее) и т.п. задач, несвязанных напрямую с регулярной установкой пакетов в контейнеры, работающие в промышленной эксплуатации.

Но с моей точки зрения регулярная достановка пакетов на проде только лишь ради деплоя (а не например, тестирования) абсолютно недопустима, когда есть возможность заменить такую процедуру заранее собранными и протестированными контейнерами, хранящимися в локальном репозитории собранных бинарных контейнеров.

Для этого существует достаточно много причин, причём которые могут возникнуть даже внезапно в самый неподходящий момент времени. Часть из них:  
* Пакеты в репозитории со временем  могут оказаться менее совместимые с вашим проектом, чем в момент его тестовой сборки. Например, `Ion shell` не собирается из последних версий пакетов в `Debian v9`, хотя прекрасно собирается из аналогичных пакетов релиза `Devuan v2 ASCII`, который является аналогом релиза `Debian v9` по версиям пакетов.
Сборка на старом дистрибутиве иногда может потребоваться, чтобы получить бинарник, запускаемый на довольно старых glibc других дистрибутивов Linux, например, в LiveCD SystemRescueCD 2018, основанном на  Gentoo.
* Инфраструктура репозитория дистрибутива может оказаться недоступной в ответственный момент времени, например, из-за её сбоя или сбоя каналов связи до этой инфраструктуры. Частично такая проблема решается созданием локального зеркала репозитория.

Добавил Prometheus в качестве источника:
![](images/datasource.png)

Для теста добавил готовый dashboard "Node Exporter Full" из стоковой коллекции:
![](images/nef.png)

## Задание 2

Изучил PromQL по предложенным ссылкам.

Создал Dashboard `Netology 10-monitoring-03-grafana` и в ней необходимые Panels со следующими PromQL запросами:
- утилизация CPU для nodeexporter (в процентах, 100-idle): `(1 - avg(irate(node_cpu_seconds_total{job="node-exporter", mode="idle"}[1m])) )* 100`
- CPU LA 1, 5, 15:
```
avg(node_load1{job="node-exporter"})
avg(node_load5{job="node-exporter"})
avg(node_load15{job="node-exporter"})
```
- количество свободной оперативной памяти: `node_memory_MemFree_bytes`
- количество места на файловой системе: `node_filesystem_avail_bytes`

Скриншот получившегося Dashboard:
![](images/dashboard.png)

## Задание 3
Добавил алерты. Пример полученных нотификаций от Grafana:
![](images/notifications.png)


## Задание 4
[Модель Dashboard](dashboard_model.json)